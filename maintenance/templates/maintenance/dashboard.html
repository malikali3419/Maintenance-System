{% extends "base.html" %}
{% load static %}



{% block content %}


    <!-- PAGE -->
    <div class="page">
        <div class="page-main">
            {% include "include/header.html" %}
            <!--app-content open-->
            <div class="main-content app-content mt-0">
                <div class="side-app">

                    <!-- CONTAINER -->
                    <div class="main-container container-fluid">

                        <!-- PAGE-HEADER -->
                        <div class="page-header">
                            
                                
                           
                            <div>
                                <ol class="breadcrumb">
                                    <li class="breadcrumb-item"><a href="javascript:void(0)">Home</a></li>
                                    <li class="breadcrumb-item active" aria-current="page">Dashboard</li>
                                </ol>
                            </div>
                        </div>
                        <!-- PAGE-HEADER END -->

                        <!-- ROW-1 -->
                     
                          
                        <!-- ROW-1 END -->


                        <!-- ROW-4 -->
                        <div class="row">
                            <!-- {% if not request.user.role == 'tech' %} -->
                            <div class="col-12 my-2" style="text-align:right">
                                <button type="button" class="btn btn-primary"  data-bs-effect="effect-rotate-left" data-bs-toggle="modal" href="#modaldemo8"><i class="fe fe-plus me-2"></i>Submit New Record</button>
                                <button type="button" class="btn btn-primary d-none toggle-cards" >Hide Cards</button>
                                {% comment %} <a class="modal-effect btn btn-success-light d-grid mb-3">Rotate Left</a> {% endcomment %}
                            </div>
                            <!-- {%endif%} -->
                            <div class="col-12 col-sm-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h3 class="card-title mb-0">Records</h3>
                                    </div>
                                    
                                    <div class="card-body pt-4">
                                        <div class="grid-margin">
                                            <div class="">
                                                <div class="panel panel-primary">
                                                  
                                                    <div class="panel-body tabs-menu-body border-0 pt-0">
                                                        <div class="tab-content">
                                                            <div class="tab-pane active" id="tab5">
                                                                <div class="table-responsive">
                                                                    <table id="data-table"
                                                                        class="table table-bordered text-nowrap mb-0">
                                                                        <thead class="border-top">
                                                                            <tr>
                                                                                <th class="bg-transparent border-bottom-0"style="width: 5%;">Record ID</th>
                                                                                <th class="bg-transparent border-bottom-0">Anrede</th>
                                                                                <th class="bg-transparent border-bottom-0">Vorname</th>
                                                                                <th  class="bg-transparent border-bottom-0">Nachname</th>
                                                                                <th class="bg-transparent border-bottom-0">Firmenbezeichnung</th>
                                                                                <th class="bg-transparent border-bottom-0">E  - mail</th>
                                                                                <th class="bg-transparent border-bottom-0">Newzletter Akzeptiert</th>
                                                                                <th class="bg-transparent border-bottom-0">Telefone</th>
                                                                                <th class="bg-transparent border-bottom-0 d-none">StarBe</th>  
                                                                                <th class="bg-transparent border-bottom-0">Nr</th>  
                                                                                <th class="bg-transparent border-bottom-0">PLZ</th>
                                                                                <th class="bg-transparent border-bottom-0">Stadt</th>
                                                                                <th class="bg-transparent border-bottom-0">Land</th>
                                                                                <th class="bg-transparent border-bottom-0">Geburtstag</th>
                                                                                <th class="bg-transparent border-bottom-0">Uid Number</th>
                                                                                <th class="bg-transparent border-bottom-0">Ammerkung</th>
                                                                              
                                                                            </tr>
                                                                        </thead>
                                                                        <tbody>
                                                                            {% for record in records %}
                                                                            <tr class="border-bottom" >
                                                                                    <td class="text-center">
                                                                                        <a href="">
                                                                                            <div class="mt-0 mt-sm-2 d-block">
                                                                                                <h6
                                                                                                    class="mb-0 fs-14 fw-semibold">
                                                                                                    {{record.id}}</h6>
                                                                                            </div>
                                                                                        
                                                                                        <a>
                                                                                    </td>
                                                                                    <td>
                                                                                        <div class="d-flex">
                                                                                            <span class="avatar bradius"
                                                                                                style="background-image: url(../assets/images/orders/10.jpg)"></span>
                                                                                            <div
                                                                                                class="ms-3 mt-0 mt-sm-2 d-block">
                                                                                                <h6
                                                                                                    class="mb-0 fs-14 fw-semibold">
                                                                                                    {{record.andrede_name}}</h6>
                                                                                            </div>
                                                                                        </div>
                                                                                    </td>
                                                                                    <td>
                                                                                        <div class="d-flex">
                                                                                            <div
                                                                                                class="mt-0 mt-sm-3 d-block">
                                                                                                <h6
                                                                                                    class="mb-0 fs-14 fw-semibold">
                                                                                                    {{record.first_name}}</h6>
                                                                                            </div>
                                                                                        </div>
                                                                                    </td>
                                                                                    <td><span class="mt-sm-2 d-block">{{record.last_name}}</span></td>
                                                                                    <td><span class="mt-sm-2 d-block">{{record.company_name}}</span></td>
                                                                                    <td><span class="mt-sm-2 d-block">{{record.email}}</span></td>
                                                                                    <td>
                                                                                        <div class="mt-sm-1 d-block text-center" data-bs-placement="top" data-bs-toggle="tooltip" title="" data-bs-original-title="{{column.status_description}}">
                                                                                            {%if record.news_accept%}
                                                                                            <input type="checkbox" class="badge bg-success-transparent rounded-pill text-{{maintenance.status.color_class}} p-2 px-3" checked/>
                                                                                            {%else%}
                                                                                            <input type="checkbox" class="badge bg-success-transparent rounded-pill text-{{maintenance.status.color_class}} p-2 px-3" />
                                                                                            {%endif%}
                                                                                            </div>
                                                                                    </td>
                                                                                    <td><span class="mt-sm-2 d-block">{{record.telefone}}</span></td>
                                                                                    <td style="display: none;"><span class="mt-sm-2 d-block badge2">{{record.telefone}}</span></td>
                                                                                   
                                                                                    <td><span class="mt-sm-2 d-block">{{record.nr}}</span></td>
                                                                                    <td><span class="mt-sm-2 d-block">{{record.postal_code}}</span></td>
                                                                                    <td><span class="mt-sm-2 d-block">{{record.stadt_name}}</span></td>
                                                                                    <td><span class="mt-sm-2 d-block">{{record.land_name.land_name}}</span></td>
                                                                                    <td><span class="mt-sm-2 d-block">{{record.birthdate}}</span></td>
                                                                                    <td><span class="mt-sm-2 d-block">{{record.uid_number}}</span></td>
                                                                                    <td><span class="mt-sm-2 d-block">{{record.ammerkung}}</span></td>

                                                                                    
                                                                                    </tr>
                                                                            {% endfor %}
                                                                        </tbody>
                                                                    </table>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- ROW-4 END -->
                 
                    <!-- CONTAINER END -->
                </div>
            </div>
            <!--app-content close-->

        </div>

      


        <!-- MODAL EFFECTS -->
        <div class="modal fade" id="modaldemo8">
            <div class="modal-dialog modal-dialog-centered text-center" role="document" style="width: 65rem !important; max-width: 100%;">
                <form  id="request_form w-100" enctype="multipart/form-data" method="POST" style="width: 65rem;">
                    {% csrf_token %}
                    <div class="modal-content modal-content-demo">
                       
                        <div class="modal-header">
                            <h6 class="modal-title">Add Record</h6><button type="button" aria-label="Close" class="btn-close" data-bs-dismiss="modal"><span aria-hidden="true">&times;</span></button>
                        </div>
                   
                        <div class="modal-body">
                            <div class="form-row">
                                <div style="display:none">
                                    <div class="form-group">
                                        <textarea name="maintenance_id" id="maintenance_id"></textarea>
                                    </div>
                                </div>
                                <div class="form-group col-md-4 mb-0">
                                    <div class="form-group">
                                        <select class="form-control" name="anrede" >
                                            <option value="none">Anrede</option>
                                           {%for item in andrede %}
                                           <option value="{{item.id}}">{{item.andrede_name}}</option>
                                           {%endfor%}
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group col-md-4 mb-0">
                                    <div class="form-group">
                                        <input type="text" class="form-control" placeholder="First Name" name="first_name">
                                    </div>
                                </div>
                                <div class="form-group col-md-4 mb-0">
                                    <div class="form-group">
                                        <input type="text" class="form-control" placeholder="Last Name" name="last_name">
                                    </div>
                                </div>
                               
                                
                            </div>
                            <div class="form-row">
                                <div class="form-group col-md-12 mb-0">
                                    <div class="form-group">
                                        <input type="text" class="form-control"  name="company_name" placeholder="Company Name" required>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <input type="email" class="form-control"  name="email" placeholder="Email" required>
                                        </div>
                                        <div class="col-md-6 d-flex text-center justify-content-center">
                                            <p class="mt-3"> Newsletter Accepted</p>
                                            <label class="switch">
                                                <input type="checkbox" name="news_accept">
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        
                            <div class="form-row p-0">
                                <div class="container-fluid p-4" id="issues ">
                                    <div class="row p-0">
                                        <div class="form-group col-md-12 mb-0 p-0">
                                         
                                           
                                            <div class="form-group p-0" style="text-align:left;">
                                                <input required  type="text" id="request_date" placeholder="Telefone" class="form-control" name="telefone">
                                            </div>
                                            <div class="row">
                                                <div class="form-group col-md-4" style="text-align:left;" id="endDate">
                                                    <input  type="text" id="request_date" placeholder="StarBe" class="form-control" name="StarBe">
                                                </div>
                                                <div class="form-group col-md-2" style="text-align:left; " id="endDate">
                                                    <input  type="text" id="request_date" placeholder="Nr" class="form-control" name="nr">
                                                </div>
                                                <div class="form-group col-md-2" style="text-align:left; " id="endDate">
                                                    <input  type="number" id="request_date" placeholder="Postal Code" class="form-control" name="postal_code">
                                                </div>
                                                <div class="form-group col-md-2" style="text-align:left;" id="endDate">
                                                    <select class="form-control" style="text-align:left;" required name="Stadt">
                                                        <option value="none">Stadt</option>
                                                        {%for item in stadt%}
                                                        <option value="{{item.id}}">{{item.stadt_name}}</option>
                                                        {%endfor%}
                                                    </select>
                                                </div>
                                            </div>
                                                <div class="form-group" style="text-align: left;">
                                                <label>Land</label>
                                            
                                                <select class="form-control" required name="land">
                                                    <option value="none">Land</option>
                                                    {%for item in land%}
                                                    <option value="{{item.id}}">{{item.land_name}}</option>
                                                    {%endfor%}
                                                </select>
                                            
                                            </div>
                                            <div class="row">
                                               <div class="form-group col-md-12" style="text-align:left;" id="endDate">
                                                <label>Birthdate</label>
                                                <input  type="date" id="request_date" placeholder="Birthdate" class="form-control" name="birthdate">
                                            </div>
                                            <div class="form-group col-md-12" style="text-align:left;" id="endDate">
                                                <input  type="number" id="request_date" placeholder="Uid Number" class="form-control" name="uid_number">
                                            </div>
                                            <div class="form-group col-md-12" style="text-align:left;" id="endDate">

                                                <input  type="text" id="request_date" placeholder="Ammerkung" class="form-control" name="ammerkung">
                                            </div>
                                            </div>
                                          
                                        </div>
                                       
                                    </div>
                                    
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="submit" 
                                    {% comment %} onclick="document.getElementById('request_form').submit();"  {% endcomment %}
                                    class="btn btn-primary">Submit</button> 
                                <button type="reset" class="btn btn-light" onclick="resetFormAndClose(this)" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                      
                    </div>
                </form>
            </div>
        </div>
       
        

        {% comment %} {% include "include/footer.html" %} {% endcomment %}

        <script>

            const button = document.querySelector('.toggle-cards');
            const content = document.querySelector('.cards-row');

            button.addEventListener('click', () => {
            content.classList.toggle('open');
                if (content.classList.contains('open')) {
                    button.textContent = 'Expand Cards'; 
                } else {
                    button.textContent = 'Hide Cards';
                }
            });
            function showStartEndDate(event){
                request_type = document.getElementById('request_type').value;
                issue_date = document.getElementById('issue_date_label');
                end_date = document.getElementById('endDate');
                if(request_type == 'audit'){
                    end_date.style.display = 'block';
                    issue_date.innerHTML = 'StartDate'
                }else{
                    end_date.style.display = 'none';
                    issue_date.innerHTML = 'Issue Date';
                }



            }
            function redirectToPage(event) {
                var redirectUrl = '/maintenance/'
                window.location.href = redirectUrl;
            }
            document.addEventListener('DOMContentLoaded', function () {
                $('#data-table thead tr')
                    .clone(true)
                    .addClass('filters')
                    .appendTo('#data-table thead');
            
                    var table = $('#data-table').DataTable({
                        orderCellsTop: true,
                        fixedHeader: true,
                        initComplete: function () {
                            var api = this.api();
                
                            // For each column
                            api
                                .columns()
                                .eq(0)
                                .each(function (colIdx) {
                                    // Set the header cell to contain the input element
                                    var cell = $('.filters th').eq(
                                        $(api.column(colIdx).header()).index()
                                    );
                                    var title = $(cell).text();
                                    $(cell).html('<input type="text" placeholder="' + title + '" />');
                
                                    // On every keypress in this input
                                    $(
                                        'input',
                                        $('.filters th').eq($(api.column(colIdx).header()).index())
                                    )
                                        .off('keyup change')
                                        .on('change', function (e) {
                                            // Get the search value
                                            $(this).attr('title', $(this).val());
                                            var regexr = '({search})'; //$(this).parents('th').find('select').val();
                
                                            var cursorPosition = this.selectionStart;
                                            // Search the column for that value
                                            api
                                                .column(colIdx)
                                                .search(
                                                    this.value != ''
                                                        ? regexr.replace('{search}', '(((' + this.value + ')))')
                                                        : '',
                                                    this.value != '',
                                                    this.value == ''
                                                )
                                                .draw();
                                        })
                                        .on('keyup', function (e) {
                                            e.stopPropagation();
                
                                            $(this).trigger('change');
                                            $(this)
                                                .focus()[0]
                                                .setSelectionRange(cursorPosition, cursorPosition);
                                        });
                                });
                        },
                    });
                });

           function resetFormAndClose() {
                const form = document.getElementById('request_form');
                form.reset();
                document.getElementById('subCategoryDiv1').style.display = 'none';
                document.getElementById('subCategoryDiv2').style.display = 'none';
                document.getElementById('subCategoryDiv3').style.display = 'none';
                document.getElementById('subCategoryDiv4').style.display = 'none';
                document.getElementById('subCategoryDiv5').style.display = 'none';

            }

            function showNextSubCategory(selectElement, nextDivNumber, getitem, loader) {
                var selectedValue = selectElement.value;
                console.log(selectedValue);
                if (getitem === 'show_desc' && selectedValue !== "other"){
                    var nextSubCategoryInput = document.getElementById("subCategoryDiv" + (nextDivNumber));
                    nextSubCategoryInput.style.display = "block";
                    return
                }
                if ( selectedValue === "other"){
                    console.log("herer");
                    console.log(nextDivNumber-1);
                    var nextSubCategoryInput = document.getElementById("input" + (nextDivNumber-1));
                    if (nextSubCategoryInput.style.display === 'none'){
                       
                    nextSubCategoryInput.style.display = "block";
                    return;
                    }
                    else{
                    nextSubCategoryInput.style.display = "none";
                }

                }else{
                        var nextSubCategoryInput = document.getElementById("input4");
                        nextSubCategoryInput.style.display = "none";
                    }

                
                
                 if (selectedValue !== "none") {
                    var url = `/api/${getitem}/${selectedValue}`; 
                    var params = new URLSearchParams();
                    params.append("param", selectedValue);
                    console.log(loader);
                    document.getElementById(loader).style.display='block';
                    fetch(url)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error("Network response was not ok");
                            }
                            return response.json();
                        })
                        .then(data => {
                            console.log(data);  
                            document.getElementById(loader).style.display='none';     
                            var nextSubCategoryDiv = document.getElementById("subCategoryDiv" + nextDivNumber);
                            nextSubCategoryDiv.style.display = "block";
                           
                            if (getitem === "getrooms"){
                                populateNextDiv(data.room, nextDivNumber,getitem);

                            }else if (getitem === "get_m_items"){
                                populateNextDiv(data.maintenance_items, nextDivNumber,getitem);
                            }else if (getitem === 'getissues'){
                                populateNextDiv(data.issues, nextDivNumber,getitem);
                            }
                            else{
                                populateNextDiv(data.units, nextDivNumber,getitem);
                            }
                        })
                        .catch(error => {
                            console.error("There was a problem with the fetch operation:", error);
                        });
                    }
                }

        function populateNextDiv(data, nextDivNumber, getitem) {
            
            var subCategorySelect = document.getElementById("subCategory" + nextDivNumber);
            subCategorySelect.innerHTML = ""
            var option = document.createElement("option");
            option.value = null
            option.text = 'Chose a value'    
            subCategorySelect.appendChild(option);        
                for (var i = 0; i < data.length; i++) {
                    var option = document.createElement("option");
                    if (getitem === "getrooms"){
                        option.value = data[i].room_no; 
                        option.text = data[i].room_no;
                    }
                    else if(getitem === 'getissues'){
                        option.value = data[i].title; 
                        option.text = data[i].title;
                    }
                    else if(getitem === 'get_m_items'){
                        option.value = data[i].name; 
                        option.text = data[i].name;
                    }
                    else{
                        option.value = data[i].name; 
                        option.text = data[i].name;
                    }
                    subCategorySelect.appendChild(option);
                }
                if(getitem === 'getissues'){
                        var option = document.createElement("option");
                        option.value = 'other'
                        option.text = 'other'
                        subCategorySelect.appendChild(option);
                    }
            }
            
            function editDelete(id) {
                document.getElementById("maintenance_delete_id").innerText = id
            }
            
            function editMaintenance(id) {
                console.log("htrere", id);
                fetch(`/api/maintenance_detail/${id}/`)
                    .then((response) => response.json())
                    .then((data) => {
                        console.log(data.request_title);
                        document.getElementById("maintenance_id").innerText = id;
                        

                        const form = document.getElementById('request_form');
                        form.reset();
                        
                        // Populate the Building select element
                        const buildingSelect = document.querySelector("select[name='issue_building']");
                        buildingSelect.value = data.building.name;
                        console.log(data);
                        
                        // Populate the Units select element
                        const unitSelect = document.querySelector("select[name='issue_unit']");
                        const roomSelect = document.querySelector("select[name='issue_room']");
                        const m_item_Select = document.querySelector("select[name='issue_maintenance_item']");
                        const item_issue_Select = document.querySelector("select[name='item_issue']");
                        const m_date = document.querySelector("input[name='request_date']");

                        const request_title = document.querySelector("input[name='request_title']");
                        m_date.value = data.formatted_enquiry_date
                        request_title.value = data.request_title;
                        // Clear existing options before adding new ones
                        unitSelect.innerHTML = "";
                        roomSelect.innerHTML = "";
                        m_item_Select.innerHTML = "";
                        item_issue_Select.innerHTML = "";

                        // Populate Units
                        data.units.forEach((unit) => {
                            const option = document.createElement("option");
                            option.value = unit.name;
                            option.textContent = unit.name;
                            unitSelect.appendChild(option);
                        });

                        // Populate Rooms
                        data.rooms.forEach((room) => {
                            const option = document.createElement("option");
                            option.value = room.room_no;
                            option.textContent = room.room_no;
                            roomSelect.appendChild(option);
                        });

                        // Populate Maintenance Items
                        data.maintenance_items.forEach((item) => {
                            const option = document.createElement("option");
                            option.value = item.name;
                            option.textContent = item.name;
                            m_item_Select.appendChild(option);
                        });

                        // Populate Issue Titles
                        data.issues.forEach((issue) => {
                            const option = document.createElement("option");
                            option.value = issue.title;
                            option.textContent = issue.title;
                            item_issue_Select.appendChild(option);
                        });

                        unitSelect.value = data.unit.name;
                        roomSelect.value = data.room.room_no;
                        m_item_Select.value = data.maintenance_item.name;
                        item_issue_Select.value = data.issue.title;
                        document.getElementById('m_desc').value = data.issue_details;

                        // Reset the display
                        document.getElementById('subCategoryDiv1').style.display = 'block';
                        document.getElementById('subCategoryDiv2').style.display = 'block';
                        document.getElementById('subCategoryDiv3').style.display = 'block';
                        document.getElementById('subCategoryDiv4').style.display = 'block';
                        document.getElementById('subCategoryDiv5').style.display = 'block';
                        unitSelect.style.display = 'block';

                        // Clear data variable
                        data = null;
                    });
}


            function fetchNotifications() {
                fetch('/api/notifications/latest') // Replace with your API endpoint URL
                    .then(response => response.json())
                    .then(data => {
                       liveToasts = document.getElementById("liveToasts")
                       liveToasts.innerHTML = ""
                       data.forEach((notification)=>{

                            if (notification.event!='change'){

                                liveToasts.innerHTML += `
                                <div class="toast fade show" role="alert" onclick="location.reload();" aria-live="assertive" aria-atomic="true">
                                    <div class="toast-header">
                                        <i class="fe fe-bell me-2" style="font-size:18px"></i>
                                        <strong class="me-auto">New notification</strong>
                                        <small id="noti-time">${notification.timestamp}</small>
                                        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"><span aria-hidden="true">×</span></button>
                                    </div>
                                    <div class="toast-body">
                                        ${notification.message}
                                    </div>
                                </div>
                                `
                            }
                       })
                    })
                    .catch(error => {
                        console.error('Error fetching notifications:', error);
                    });
            }
            const interval = setInterval(fetchNotifications, 5000);

        </script>
        
    <div class="position-fixed bottom-0 end-0 p-3"id="liveToasts">
        
    </div>
    </div>

{% endblock content %}